# -=-=-=-=-=-=-=-=-=- 
#  search_google.py
# -=-=-=-=-=-=-=-=-=-
# IDAPython plugging adding "Search Google for..." to right click context menu
# Created By Omri Ben-Bassat of Intezer Labs
# Visit us at http://intezer.com
#

import os
import idaapi

highlight = ""

icon_data = "".join(["\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52",
                     "\x00\x00\x00\x10\x00\x00\x00\x10\x08\x06\x00\x00\x00\x1F\xF3\xFF",
                     "\x61\x00\x00\x00\x01\x73\x52\x47\x42\x00\xAE\xCE\x1C\xE9\x00\x00",
                     "\x00\x04\x67\x41\x4D\x41\x00\x00\xB1\x8F\x0B\xFC\x61\x05\x00\x00",
                     "\x00\x09\x70\x48\x59\x73\x00\x00\x0E\xC4\x00\x00\x0E\xC4\x01\x95",
                     "\x2B\x0E\x1B\x00\x00\x02\x62\x49\x44\x41\x54\x38\x4F\x8D\x93\x49",
                     "\x68\x53\x51\x14\x86\xFF\xFB\x92\x97\x9A\xB9\x03\x0D\xAD\x14\x9B",
                     "\x9A\xBA\x70\x23\x52\xE9\x80\xA2\x5D\x38\xE1\x42\x41\x69\xC1\xA1",
                     "\x08\x82\x5B\xBB\x77\x40\x37\xA5\x0B\x17\x2A\x74\x15\x82\xD0\x85",
                     "\x05\x87\x96\x82\x74\xE5\x80\x34\x2E\xA4\x8A\x55\xAC\x0D\x15\x1C",
                     "\x52\x92\xD4\x36\x4D\x4C\xD3\xA4\xCD\xF0\x86\xE3\xCD\xCB\x6B\x62",
                     "\x6C\x05\xBF\xC7\x7D\xDC\x7B\xCE\x3D\xFF\x7D\xE7\xDC\xF3\x18\x71",
                     "\xB0\x05\x72\xF0\x07\xA4\xCF\x1F\x00\x49\x82\xA1\xD9\x0D\x53\x5B",
                     "\xA7\xEE\xA9\x64\x93\xC0\xDA\xB0\x17\xAB\x03\xD7\x01\x51\x84\x60",
                     "\xB5\x01\x02\x03\x65\x73\x50\x63\x51\x98\xCF\x5E\x44\xCD\x1D\xAF",
                     "\xBE\xB3\x48\x85\x40\xF4\x58\x17\xD4\xA5\x45\x18\xEA\x5D\x20\x45",
                     "\xE1\x81\x59\x80\x54\x30\xD1\x04\xB6\xCD\x0C\x5A\x4B\x21\x1F\x08",
                     "\xA0\x69\xA5\x7C\x66\x49\x60\xF9\x64\x37\x28\x1E\x07\xB3\x5A\x21",
                     "\x47\xC2\x30\x7A\x5A\x61\x39\xD5\x03\x62\x02\xE4\x2F\x01\x64\x9E",
                     "\x3C\xD0\xE6\x0D\x9F\xE6\x21\xD8\x1D\x5A\xB0\x46\x41\x60\x7D\x62",
                     "\x9C\x22\x4D\x2D\x14\x3D\xDA\x41\x11\xB7\x93\x32\x93\x2F\x0B\xE6",
                     "\x0A\xA4\xF9\x20\x49\xDF\xBF\xEA\xAB\x32\x9A\x80\x3C\x05\x4A\xDF",
                     "\xAB\xA7\x50\xC3\x1E\x4A\x8F\xDC\xD7\x1C\xFF\x0B\x53\xF9\x4B\x1E",
                     "\x67\x10\xB6\x03\xF9\x19\xC0\x7C\xB9\xF2\x52\x9E\xBE\x97\xA0\x72",
                     "\x13\x63\xBA\x41\x27\x95\x25\x5C\xD8\x2F\x82\xA9\xC9\x77\x24\xFB",
                     "\xDB\x81\x2A\x5E\xF0\xDA\x83\x30\xEC\xF3\xEB\x5B\x8A\xB4\xDF\x48",
                     "\x43\x52\xA8\x70\x19\x25\x0A\x62\x0B\x09\xC2\xEB\x5B\x56\x08\xBA",
                     "\x4D\xC3\xA0\xAA\xFA\xAC\x8C\x68\x00\x4C\x22\x43\x95\x3E\x9C\x56",
                     "\x01\xD5\x7C\xD4\xD9\x79\x71\x15\x2E\xB6\x91\x82\x58\x0D\x4C\xAF",
                     "\x00\x6D\xA7\x2B\x53\x18\x7A\xC6\x7B\x80\xEB\x16\x4E\xB5\xF1\xAF",
                     "\x1C\x7D\x2B\x23\x2B\x11\x42\xBF\x08\xD3\x03\xBC\x4F\xB4\x4A\x3C",
                     "\x07\x3D\x9E\xF0\x10\x7C\x3D\x34\x3C\x3B\xA6\x99\xFE\x85\xBB\x7F",
                     "\x95\x0E\x0F\xA6\xA9\xF9\x4A\x52\x5B\x6B\x29\x8C\xB5\xBC\xC0\xB9",
                     "\x05\x0F\x3A\x1D\x84\x7E\xFF\x20\x5E\x85\xA7\xB4\xD3\xFF\xE6\xD0",
                     "\x4D\xC0\xED\xE2\xDD\xCA\x0B\x78\xFE\x80\x49\xB3\x95\x1A\xA9\x7B",
                     "\xB4\x0F\xB1\x5C\x02\x56\xA3\x05\xA1\xD4\x4F\xEC\xAA\x71\xA3\xB7",
                     "\xF5\x38\x18\x7F\x82\x7C\xED\x9B\xF3\x61\x37\x5D\x82\x23\x74\x15",
                     "\xB3\x89\x24\x22\x43\xCE\x4A\x81\x02\x1D\x8F\x7A\xB1\xB4\x1E\x87",
                     "\xCB\x52\x0B\x45\x55\x90\x55\x78\xFE\xDC\x2D\x0A\x46\x98\x8D\x66",
                     "\x64\xB0\x8C\x6F\x8B\x2A\x82\x7D\x93\x70\xD5\x15\x63\x36\xFD\x4C",
                     "\xDE\x99\x87\xB8\xF6\xE6\x2E\x8C\x3C\xC8\x2E\x5A\x78\xF1\x04\xE4",
                     "\x94\x3C\x17\x8E\xE1\xCC\xCE\x23\x18\x39\x71\x9B\x5F\x9D\xA8\xEF",
                     "\xDE\x42\x60\x83\x60\x32\x8C\x8F\xB1\x39\xE4\x55\x09\x3B\x6C\x8D",
                     "\xE8\x6A\xDC\xAB\x7B\xFE\x04\xF8\x0D\x1A\x8F\x87\xFA\x45\xCC\x17",
                     "\x75\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"])

act_icon = idaapi.load_custom_icon(data=icon_data, format="png")
                     
class SearchHandler(idaapi.action_handler_t):
    def __init__(self):
        idaapi.action_handler_t.__init__(self)
        
    def activate(self, ctx):
        os.system("START https://www.google.com/search?q=\"" + highlight[0] + "\"")
        
        return 1
        
    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS

action_desc = idaapi.action_desc_t('search:action',
                                   'Search Google for \"\"',
                                   SearchHandler(),
                                   None,
                                   None,
                                   act_icon)

idaapi.register_action(action_desc)

class Hooks(idaapi.UI_Hooks):
    def populating_tform_popup(self, form, popup):
        global highlight
        
        if idaapi.get_tform_type(form) == idaapi.BWN_DISASM:
            highlight = idaapi.get_highlight(form)
            if highlight:
                idaapi.update_action_label("search:action", "Search Google for \"" + highlight[0] + "\"")
                idaapi.attach_action_to_popup(form, popup, "search:action", None)

hooks = Hooks()
hooks.hook()